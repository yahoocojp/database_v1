<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&D Experiment Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/dist/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: #1e1e2a;
            --bg-hover: #252535;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2a2a3a;
            --border-light: #3a3a4a;
            --layer-material: #22d3ee;
            --layer-heat: #f59e0b;
            --layer-product: #10b981;
            --layer-tp: #a78bfa;
            --layer-analysis: #f472b6;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; height: 100vh; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1em; font-weight: bold; color: white; }
        .logo-text h1 { font-size: 0.9em; font-weight: 600; }
        .logo-text span { font-size: 0.7em; color: var(--text-muted); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 12px; }
        .sidebar-content::-webkit-scrollbar { width: 4px; }
        .sidebar-content::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }
        .panel { background: var(--bg-card); border-radius: var(--radius-md); padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .panel-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .panel-icon { width: 24px; height: 24px; background: var(--bg-tertiary); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; }
        .panel-title { font-size: 0.7em; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        .stat-card { background: var(--bg-tertiary); border-radius: var(--radius-sm); padding: 6px 2px; text-align: center; cursor: pointer; transition: var(--transition); border-bottom: 2px solid var(--stat-color, var(--accent-primary)); }
        .stat-card:hover { background: var(--bg-hover); transform: translateY(-1px); }
        .stat-card.active { background: var(--bg-hover); }
        .stat-value { font-size: 1em; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-label { font-size: 0.55em; color: var(--text-muted); margin-top: 1px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 4px; }
        .filter-btn { padding: 5px 8px; font-size: 0.7em; font-weight: 500; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: 12px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 3px; }
        .filter-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .filter-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .filter-btn .dot { width: 6px; height: 6px; border-radius: 50%; }
        .btn { padding: 8px 12px; font-size: 0.75em; font-weight: 500; border: none; border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; margin-bottom: 6px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: 6px 10px; font-size: 0.7em; margin-bottom: 0; width: auto; }
        .main-area { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .toolbar { height: 44px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 12px; gap: 8px; flex-shrink: 0; }
        .toolbar-btn { padding: 5px 8px; font-size: 0.7em; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition); }
        .toolbar-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .toolbar-btn.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .toolbar-divider { width: 1px; height: 20px; background: var(--border-color); }
        .toolbar-spacer { flex: 1; }
        .status-indicator { display: flex; align-items: center; gap: 5px; font-size: 0.65em; color: var(--text-muted); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); }
        .graph-container { flex: 1; position: relative; overflow: hidden; }
        #graph { width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, var(--bg-tertiary) 0%, transparent 70%), linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(90deg, var(--border-color) 1px, transparent 1px); background-size: 100% 100%, 40px 40px, 40px 40px; }
        
        /* Layer Legend - improved */
        .layer-legend { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px; background: var(--bg-secondary); padding: 5px 10px; border-radius: 16px; border: 1px solid var(--border-color); z-index: 10; }
        .legend-item { display: flex; align-items: center; gap: 3px; font-size: 0.65em; color: var(--text-secondary); cursor: pointer; padding: 3px 6px; border-radius: 10px; transition: var(--transition); }
        .legend-item:hover { background: var(--bg-tertiary); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

        /* Zoom Controls */
        .zoom-controls { position: absolute; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 4px; z-index: 15; }
        .zoom-btn { width: 36px; height: 36px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .zoom-btn:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
        .zoom-level { font-size: 0.65em; color: var(--text-muted); text-align: center; padding: 4px 0; }

        /* Minimap - larger */
        .minimap { position: absolute; bottom: 20px; right: 340px; width: 220px; height: 150px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; z-index: 15; }
        .minimap-canvas { width: 100%; height: 100%; }
        .minimap-viewport { position: absolute; border: 2px solid var(--accent-primary); background: rgba(99, 102, 241, 0.1); pointer-events: none; }
        .minimap-title { position: absolute; top: 4px; left: 8px; font-size: 0.6em; color: var(--text-muted); text-transform: uppercase; }

        /* Layer Jump Buttons - moved above zoom controls */
        .layer-jump { position: absolute; bottom: 200px; left: 20px; display: flex; flex-direction: column; gap: 4px; z-index: 15; }
        .layer-jump-btn { width: 56px; height: 28px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 0.6em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); font-weight: 600; }
        .layer-jump-btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--accent-primary); }

        /* Detail Panel */
        .detail-panel { position: absolute; bottom: 12px; right: 12px; width: 300px; max-height: 55vh; background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); overflow: hidden; transform: translateY(20px); opacity: 0; pointer-events: none; transition: var(--transition); z-index: 20; }
        .detail-panel.active { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .detail-header { padding: 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .detail-title { display: flex; align-items: center; gap: 6px; }
        .detail-badge { padding: 2px 6px; font-size: 0.6em; font-weight: 600; border-radius: 8px; text-transform: uppercase; }
        .detail-id { font-size: 0.85em; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .detail-close { width: 22px; height: 22px; background: var(--bg-card); border: none; border-radius: var(--radius-sm); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em; }
        .detail-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .detail-body { padding: 12px; max-height: 200px; overflow-y: auto; }
        .detail-section { margin-bottom: 10px; }
        .detail-section-title { font-size: 0.65em; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-key { font-size: 0.7em; color: var(--text-muted); }
        .detail-value { font-size: 0.75em; font-weight: 500; font-family: 'JetBrains Mono', monospace; }
        .detail-actions { padding: 10px 12px; border-top: 1px solid var(--border-color); display: flex; gap: 6px; }
        .detail-actions .btn { flex: 1; padding: 6px; font-size: 0.7em; margin-bottom: 0; }

        /* Table Drawer */
        .table-drawer { position: absolute; bottom: 0; left: 0; right: 0; height: 40%; background: var(--bg-secondary); border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s; z-index: 30; display: flex; flex-direction: column; }
        .table-drawer.active { transform: translateY(0); }
        .drawer-header { padding: 10px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .drawer-title { font-size: 0.85em; font-weight: 600; }
        .drawer-tabs { display: flex; gap: 4px; }
        .drawer-tab { padding: 5px 10px; font-size: 0.7em; background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); border-radius: var(--radius-sm); cursor: pointer; }
        .drawer-tab:hover { background: var(--bg-hover); }
        .drawer-tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }
        .drawer-close { background: var(--bg-card); border: none; color: var(--text-muted); padding: 5px 10px; border-radius: var(--radius-sm); cursor: pointer; font-size: 0.7em; }
        .drawer-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .drawer-body { flex: 1; overflow: auto; padding: 12px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.75em; }
        .data-table th, .data-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: var(--bg-tertiary); color: var(--text-secondary); font-weight: 600; position: sticky; top: 0; }
        .data-table tr:hover { background: var(--bg-hover); cursor: pointer; }
        .data-table td { font-family: 'JetBrains Mono', monospace; }

        /* Compare Panel */
        .compare-panel { position: absolute; top: 50px; right: 12px; width: 400px; max-height: 70vh; background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); box-shadow: var(--shadow-lg); overflow: hidden; transform: translateX(120%); transition: transform 0.3s; z-index: 25; }
        .compare-panel.active { transform: translateX(0); }
        .compare-header { padding: 12px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .compare-title { font-size: 0.85em; font-weight: 600; }
        .compare-body { padding: 12px; max-height: 60vh; overflow-y: auto; }
        .compare-grid { display: grid; gap: 8px; }
        .compare-row { display: grid; grid-template-columns: 100px 1fr 1fr; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-color); }
        .compare-row:last-child { border-bottom: none; }
        .compare-label { font-size: 0.7em; color: var(--text-muted); }
        .compare-value { font-size: 0.75em; font-family: 'JetBrains Mono', monospace; background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; }
        .compare-value.diff { background: rgba(239, 68, 68, 0.2); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-color); width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 1em; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.2em; cursor: pointer; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 16px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px; }

        /* Form */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 0.75em; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 8px 10px; font-size: 0.8em; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-primary); }
        .form-textarea { min-height: 100px; resize: vertical; }

        /* Paste Area */
        .paste-area { border: 2px dashed var(--border-color); border-radius: var(--radius-md); padding: 20px; text-align: center; cursor: pointer; transition: var(--transition); margin-bottom: 12px; }
        .paste-area:hover, .paste-area.dragover { border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.1); }
        .paste-area-text { font-size: 0.8em; color: var(--text-muted); }
        .paste-area-hint { font-size: 0.7em; color: var(--text-muted); margin-top: 4px; }

        /* Mapping */
        .mapping-container { margin-top: 12px; }
        .mapping-row { display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
        .mapping-arrow { color: var(--text-muted); }
        .mapping-select { padding: 6px; font-size: 0.75em; }
        .preview-table { margin-top: 12px; max-height: 150px; overflow: auto; }
        .preview-table table { width: 100%; font-size: 0.7em; }
        .preview-table th, .preview-table td { padding: 4px 6px; border: 1px solid var(--border-color); }
        .preview-table th { background: var(--bg-tertiary); }

        /* Toast */
        .toast { position: fixed; top: 12px; right: 12px; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 8px; transform: translateX(120%); transition: transform 0.3s; z-index: 1000; font-size: 0.8em; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--info); }
        .toast.warning { border-left: 3px solid var(--warning); }

        /* Loading */
        .loading-overlay { position: absolute; inset: 0; background: rgba(10, 10, 15, 0.8); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; pointer-events: none; transition: var(--transition); }
        .loading-overlay.active { opacity: 1; pointer-events: auto; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border-color); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Orphan indicator */
        .orphan-section { position: absolute; bottom: 150px; left: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 8px 12px; z-index: 10; }
        .orphan-title { font-size: 0.65em; color: var(--text-muted); margin-bottom: 4px; }
        .orphan-count { font-size: 0.8em; font-weight: 600; color: var(--warning); }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">E</div>
                    <div class="logo-text">
                        <h1>Experiment Manager</h1>
                        <span>v2.0 - Enhanced UI</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-content">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">#</div>
                        <span class="panel-title">Statistics</span>
                    </div>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">F</div>
                        <span class="panel-title">Layer Filter</span>
                    </div>
                    <div class="filter-group" id="layerFilters"></div>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">+</div>
                        <span class="panel-title">Add Data</span>
                    </div>
                    <button class="btn btn-primary" onclick="openAddModal()">+ Add Node</button>
                    <button class="btn btn-secondary" onclick="openPasteModal()">Paste from Excel</button>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">V</div>
                        <span class="panel-title">View</span>
                    </div>
                    <button class="btn btn-secondary" onclick="toggleTableDrawer()">Table View</button>
                    <button class="btn btn-secondary" onclick="toggleCompareMode()">Compare Mode</button>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">L</div>
                        <span class="panel-title">Layout</span>
                    </div>
                    <button class="btn btn-secondary" onclick="cycleLayout()">Change Layout</button>
                    <button class="btn btn-secondary" onclick="toggleOrphanHighlight()">Show Orphans</button>
                </div>
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">D</div>
                        <span class="panel-title">Data Source</span>
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot" style="background: var(--warning);"></span>
                        <span>Sample Data Mode</span>
                    </div>
                </div>
            </div>
        </aside>
        <main class="main-area">
            <div class="toolbar">
                <button class="toolbar-btn" onclick="fitGraph()">Fit</button>
                <button class="toolbar-btn" onclick="resetView()">Reset</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" id="btnTrace" onclick="toggleTraceMode()">Trace</button>
                <button class="toolbar-btn" id="btnIsolate" onclick="isolateSelected()">Isolate</button>
                <button class="toolbar-btn" id="btnCompare" onclick="toggleCompareMode()">Compare</button>
                <div class="toolbar-divider"></div>
                <button class="toolbar-btn" onclick="exportData()">Export</button>
                <div class="toolbar-spacer"></div>
                <span id="selectionInfo" style="font-size:0.7em;color:var(--text-muted);"></span>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span id="zoomDisplay">100%</span>
                </div>
            </div>
            <div class="graph-container">
                <div class="layer-legend" id="layerLegend"></div>
                
                <!-- Zoom Controls -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                    <button class="zoom-btn" onclick="fitGraph()" style="font-size:0.7em;margin-top:8px;">FIT</button>
                </div>

                <!-- Layer Jump -->
                <div class="layer-jump" id="layerJump"></div>

                <!-- Minimap -->
                <div class="minimap" id="minimap">
                    <div class="minimap-title">Overview</div>
                    <canvas class="minimap-canvas" id="minimapCanvas"></canvas>
                    <div class="minimap-viewport" id="minimapViewport"></div>
                </div>

                <div id="graph"></div>
                
                <div class="detail-panel" id="detailPanel">
                    <div class="detail-header">
                        <div class="detail-title">
                            <span class="detail-badge" id="detailBadge">Material</span>
                            <span class="detail-id" id="detailId">M001</span>
                        </div>
                        <button class="detail-close" onclick="hideDetail()">x</button>
                    </div>
                    <div class="detail-body" id="detailBody"></div>
                    <div class="detail-actions">
                        <button class="btn btn-secondary" onclick="editNode()">Edit</button>
                        <button class="btn btn-secondary" onclick="isolateSelected()">Isolate</button>
                        <button class="btn btn-primary" onclick="showTrace()">Trace</button>
                    </div>
                </div>

                <div class="compare-panel" id="comparePanel">
                    <div class="compare-header">
                        <span class="compare-title">Compare (<span id="compareCount">0</span>)</span>
                        <button class="drawer-close" onclick="closeCompare()">Close</button>
                    </div>
                    <div class="compare-body" id="compareBody"></div>
                </div>

                <div class="table-drawer" id="tableDrawer">
                    <div class="drawer-header">
                        <span class="drawer-title">Table View</span>
                        <div class="drawer-tabs" id="drawerTabs"></div>
                        <button class="drawer-close" onclick="toggleTableDrawer()">Close</button>
                    </div>
                    <div class="drawer-body" id="drawerBody"></div>
                </div>

                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Node Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Add Node</span>
                <button class="modal-close" onclick="closeAddModal()">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Layer Type</label>
                    <select class="form-select" id="addLayerType" onchange="updateAddForm()">
                        <option value="material">Material</option>
                        <option value="heatTreatment">Heat Treatment</option>
                        <option value="product">Product</option>
                        <option value="testPiece">Test Piece</option>
                    </select>
                </div>
                <div id="addFormFields"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeAddModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="submitAddNode()">Add</button>
            </div>
        </div>
    </div>

    <!-- Edit Node Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Node: <span id="editNodeId"></span></span>
                <button class="modal-close" onclick="closeEditModal()">x</button>
            </div>
            <div class="modal-body" id="editFormFields"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="submitEditNode()">Save</button>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div class="modal-overlay" id="pasteModal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <span class="modal-title">Paste from Excel</span>
                <button class="modal-close" onclick="closePasteModal()">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Target Layer</label>
                    <select class="form-select" id="pasteLayerType">
                        <option value="material">Material</option>
                        <option value="heatTreatment">Heat Treatment</option>
                        <option value="product">Product</option>
                        <option value="testPiece">Test Piece</option>
                    </select>
                </div>
                <div class="paste-area" id="pasteArea" onclick="document.getElementById('pasteInput').focus()">
                    <div class="paste-area-text">Click here and paste (Ctrl+V)</div>
                    <div class="paste-area-hint">Or drag and drop TSV/CSV file</div>
                    <textarea id="pasteInput" style="position:absolute;opacity:0;width:1px;height:1px;" onpaste="handlePaste(event)"></textarea>
                </div>
                <div id="mappingSection" style="display:none;">
                    <div class="form-label">Column Mapping</div>
                    <div class="mapping-container" id="mappingContainer"></div>
                    <div class="preview-table" id="previewTable"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closePasteModal()">Cancel</button>
                <button class="btn btn-primary btn-sm" id="pasteSubmitBtn" onclick="submitPasteData()" disabled>Import</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastText">Message</span></div>

    <script>
        // ========================================
        // Configuration
        // ========================================
        var layerConfig = {
            material: { name: 'Material', color: '#22d3ee', fields: ['id', 'steelGrade', 'maker', 'shape', 'dimension', 'note'] },
            heatTreatment: { name: 'Heat', color: '#f59e0b', fields: ['id', 'quenchMethod', 'quenchTemp', 'quenchTime', 'quenchCool', 'temperMethod', 'temperTemp', 'temperTime', 'note'] },
            product: { name: 'Product', color: '#10b981', fields: ['id', 'materialId', 'heatTreatId', 'createdAt', 'stock', 'note'] },
            testPiece: { name: 'TP', color: '#a78bfa', fields: ['id', 'productId', 'processId', 'status', 'stamp', 'note'] },
            analysisSample: { name: 'Analysis', color: '#f472b6', fields: ['id', 'testPieceId', 'productId', 'hardness', 'note'] }
        };

        var network = null;
        var nodesData = null;
        var edgesData = null;
        var allNodes = [];
        var allEdges = [];
        var rawData = {};
        var currentFilter = 'all';
        var selectedNode = null;
        var traceModeActive = false;
        var compareModeActive = false;
        var compareList = [];
        var tableDrawerOpen = false;
        var currentTableLayer = 'material';
        var pastedData = null;
        var columnMapping = {};
        var currentLayoutIndex = 0;
        var layouts = ['LR', 'TB', 'RL'];
        var orphanHighlightActive = false;

        // ========================================
        // Initialization
        // ========================================
        function init() {
            showLoading(true);
            renderFilters();
            renderLegend();
            renderLayerJump();
            loadData();
            setupPasteArea();
            setupMinimap();
        }

        function loadData() {
            fetch('/api/nodes')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    allNodes = data.nodes || [];
                    allEdges = data.edges || [];
                    loadRawData();
                })
                .catch(function(err) {
                    showLoading(false);
                    showToast('Error: ' + err.message, 'error');
                });
        }

        function loadRawData() {
            Promise.all([
                fetch('/api/materials').then(function(r) { return r.json(); }),
                fetch('/api/heat-treatments').then(function(r) { return r.json(); }),
                fetch('/api/products').then(function(r) { return r.json(); }),
                fetch('/api/test-pieces').then(function(r) { return r.json(); }),
                fetch('/api/analysis-samples').then(function(r) { return r.json(); })
            ]).then(function(results) {
                rawData.material = results[0];
                rawData.heatTreatment = results[1];
                rawData.product = results[2];
                rawData.testPiece = results[3];
                rawData.analysisSample = results[4];
                renderStats();
                buildGraph();
                showLoading(false);
                showToast(allNodes.length + ' nodes loaded', 'success');
            });
        }

        // ========================================
        // Stats & Filters
        // ========================================
        function renderStats() {
            var grid = document.getElementById('statsGrid');
            var counts = {};
            Object.keys(layerConfig).forEach(function(k) { counts[k] = 0; });
            allNodes.forEach(function(n) { counts[n.layerId]++; });
            var html = '';
            Object.keys(layerConfig).forEach(function(key) {
                var cfg = layerConfig[key];
                var active = currentFilter === key ? ' active' : '';
                html += '<div class="stat-card' + active + '" style="--stat-color:' + cfg.color + ';" onclick="filterLayer(\'' + key + '\')">';
                html += '<div class="stat-value" style="color:' + cfg.color + ';">' + counts[key] + '</div>';
                html += '<div class="stat-label">' + cfg.name + '</div></div>';
            });
            grid.innerHTML = html;
        }

        function renderFilters() {
            var container = document.getElementById('layerFilters');
            var html = '<button class="filter-btn active" onclick="filterLayer(\'all\', this)">All</button>';
            Object.keys(layerConfig).forEach(function(key) {
                var cfg = layerConfig[key];
                html += '<button class="filter-btn" onclick="filterLayer(\'' + key + '\', this)">';
                html += '<span class="dot" style="background:' + cfg.color + ';"></span>' + cfg.name + '</button>';
            });
            container.innerHTML = html;
        }

        function renderLegend() {
            var container = document.getElementById('layerLegend');
            var html = '';
            Object.keys(layerConfig).forEach(function(key) {
                var cfg = layerConfig[key];
                html += '<div class="legend-item" onclick="filterLayer(\'' + key + '\')">';
                html += '<span class="legend-dot" style="background:' + cfg.color + ';"></span>' + cfg.name + '</div>';
            });
            container.innerHTML = html;
        }

        function renderLayerJump() {
            var container = document.getElementById('layerJump');
            var html = '';
            Object.keys(layerConfig).forEach(function(key) {
                var cfg = layerConfig[key];
                html += '<button class="layer-jump-btn" style="border-left:3px solid ' + cfg.color + ';" onclick="jumpToLayer(\'' + key + '\')">' + cfg.name + '</button>';
            });
            container.innerHTML = html;
        }

        function filterLayer(layerId, btn) {
            currentFilter = layerId;
            document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
            if (btn) btn.classList.add('active');
            if (!nodesData) return;
            nodesData.forEach(function(node) {
                var visible = layerId === 'all' || node.layerId === layerId;
                nodesData.update({ id: node.id, hidden: !visible });
            });
            renderStats();
            updateMinimap();
        }

        function jumpToLayer(layerId) {
            var layerNodes = [];
            nodesData.forEach(function(node) {
                if (node.layerId === layerId) layerNodes.push(node.id);
            });
            if (layerNodes.length > 0) {
                network.fit({ nodes: layerNodes, animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
            }
        }

        // ========================================
        // Graph - Enhanced
        // ========================================
        function buildGraph() {
            var container = document.getElementById('graph');
            
            // Improved node styling
            var visNodes = allNodes.map(function(n) {
                return {
                    id: n.id,
                    label: n.label,
                    level: n.level,
                    layerId: n.layerId,
                    color: {
                        background: n.color,
                        border: n.color,
                        highlight: { background: '#ffffff', border: n.color },
                        hover: { background: lightenColor(n.color, 20), border: n.color }
                    },
                    font: { color: '#1a1a25', size: 12, face: 'Inter', bold: true },
                    shape: 'box',
                    borderWidth: 2,
                    borderWidthSelected: 4,
                    margin: { top: 10, bottom: 10, left: 12, right: 12 },
                    shadow: { enabled: true, color: 'rgba(0,0,0,0.3)', size: 6, x: 2, y: 2 },
                    _data: n
                };
            });

            var visEdges = allEdges.map(function(e, i) {
                return {
                    id: 'e' + i,
                    from: e.from,
                    to: e.to,
                    color: { color: '#4a4a5a', highlight: '#6366f1', hover: '#6366f1' },
                    width: 2,
                    arrows: { to: { enabled: true, scaleFactor: 0.5, type: 'arrow' } },
                    smooth: { type: 'cubicBezier', roundness: 0.4 }
                };
            });

            nodesData = new vis.DataSet(visNodes);
            edgesData = new vis.DataSet(visEdges);

            var options = {
                layout: {
                    hierarchical: {
                        enabled: true,
                        direction: layouts[currentLayoutIndex],
                        sortMethod: 'directed',
                        levelSeparation: 120,
                        nodeSpacing: 40,
                        treeSpacing: 60,
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: true
                    }
                },
                physics: { enabled: false },
                interaction: {
                    hover: true,
                    multiselect: true,
                    navigationButtons: false,
                    keyboard: { enabled: true, speed: { x: 10, y: 10, zoom: 0.02 } },
                    zoomView: true,
                    dragView: true
                },
                nodes: {
                    scaling: { min: 10, max: 30 }
                }
            };

            network = new vis.Network(container, { nodes: nodesData, edges: edgesData }, options);

            network.on('click', handleNodeClick);
            network.on('selectNode', updateSelectionInfo);
            network.on('deselectNode', updateSelectionInfo);
            network.on('zoom', updateZoomDisplay);
            network.on('dragEnd', updateMinimap);
            network.on('zoom', updateMinimap);

            network.once('afterDrawing', function() {
                network.fit({ animation: { duration: 500 } });
                updateMinimap();
            });
        }

        function handleNodeClick(params) {
            if (params.nodes.length > 0) {
                var nodeId = params.nodes[0];
                var node = nodesData.get(nodeId);
                selectedNode = node;
                if (compareModeActive) {
                    toggleCompareItem(nodeId, node);
                } else {
                    showDetail(node);
                    if (traceModeActive) highlightTrace(nodeId);
                }
            } else {
                if (!compareModeActive) {
                    hideDetail();
                    selectedNode = null;
                }
                if (traceModeActive) clearHighlight();
            }
            updateMinimap();
        }

        function updateSelectionInfo() {
            var selected = network.getSelectedNodes();
            var info = document.getElementById('selectionInfo');
            if (compareModeActive && compareList.length > 0) {
                info.textContent = compareList.length + ' selected for compare';
            } else if (selected.length > 0) {
                info.textContent = selected.length + ' selected';
            } else {
                info.textContent = '';
            }
        }

        // ========================================
        // Zoom Controls
        // ========================================
        function zoomIn() {
            var scale = network.getScale();
            network.moveTo({ scale: scale * 1.3, animation: { duration: 200 } });
        }

        function zoomOut() {
            var scale = network.getScale();
            network.moveTo({ scale: scale / 1.3, animation: { duration: 200 } });
        }

        function updateZoomDisplay() {
            var scale = network.getScale();
            var percent = Math.round(scale * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomDisplay').textContent = percent + '%';
            updateMinimap();
        }

        // ========================================
        // Minimap
        // ========================================
        function setupMinimap() {
            var canvas = document.getElementById('minimapCanvas');
            canvas.width = 220;
            canvas.height = 150;
        }

        function updateMinimap() {
            if (!network || !nodesData) return;
            
            var canvas = document.getElementById('minimapCanvas');
            var ctx = canvas.getContext('2d');
            var viewport = document.getElementById('minimapViewport');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1a1a25';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            var positions = network.getPositions();
            var nodeIds = Object.keys(positions);
            if (nodeIds.length === 0) return;

            // Calculate bounds
            var minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            nodeIds.forEach(function(id) {
                var pos = positions[id];
                if (pos.x < minX) minX = pos.x;
                if (pos.x > maxX) maxX = pos.x;
                if (pos.y < minY) minY = pos.y;
                if (pos.y > maxY) maxY = pos.y;
            });

            var padding = 20;
            var rangeX = maxX - minX + padding * 2;
            var rangeY = maxY - minY + padding * 2;
            var scaleX = canvas.width / rangeX;
            var scaleY = canvas.height / rangeY;
            var scale = Math.min(scaleX, scaleY);

            // Draw nodes
            nodeIds.forEach(function(id) {
                var node = nodesData.get(id);
                if (!node || node.hidden) return;
                var pos = positions[id];
                var x = (pos.x - minX + padding) * scale;
                var y = (pos.y - minY + padding) * scale;
                ctx.fillStyle = node.color.background || '#6366f1';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw viewport indicator
            var viewPos = network.getViewPosition();
            var viewScale = network.getScale();
            var graphContainer = document.getElementById('graph');
            var viewWidth = graphContainer.clientWidth / viewScale;
            var viewHeight = graphContainer.clientHeight / viewScale;

            var vpX = (viewPos.x - viewWidth/2 - minX + padding) * scale;
            var vpY = (viewPos.y - viewHeight/2 - minY + padding) * scale;
            var vpW = viewWidth * scale;
            var vpH = viewHeight * scale;

            viewport.style.left = Math.max(0, vpX) + 'px';
            viewport.style.top = Math.max(0, vpY + 16) + 'px';
            viewport.style.width = Math.min(vpW, canvas.width) + 'px';
            viewport.style.height = Math.min(vpH, canvas.height - 16) + 'px';
        }

        // ========================================
        // Layout Cycling
        // ========================================
        function cycleLayout() {
            currentLayoutIndex = (currentLayoutIndex + 1) % layouts.length;
            var direction = layouts[currentLayoutIndex];
            var directionNames = { 'LR': 'Left to Right', 'TB': 'Top to Bottom', 'RL': 'Right to Left' };
            
            network.setOptions({
                layout: {
                    hierarchical: {
                        direction: direction
                    }
                }
            });
            
            setTimeout(function() {
                network.fit({ animation: { duration: 500 } });
                updateMinimap();
            }, 100);
            
            showToast('Layout: ' + directionNames[direction], 'info');
        }

        // ========================================
        // Orphan Highlighting
        // ========================================
        function toggleOrphanHighlight() {
            orphanHighlightActive = !orphanHighlightActive;
            
            if (orphanHighlightActive) {
                var connectedNodes = new Set();
                allEdges.forEach(function(e) {
                    connectedNodes.add(e.from);
                    connectedNodes.add(e.to);
                });
                
                var orphanCount = 0;
                nodesData.forEach(function(node) {
                    var isOrphan = !connectedNodes.has(node.id);
                    if (isOrphan) {
                        orphanCount++;
                        nodesData.update({
                            id: node.id,
                            borderWidth: 4,
                            shapeProperties: { borderDashes: [5, 5] }
                        });
                    }
                });
                showToast(orphanCount + ' orphan nodes highlighted', 'warning');
            } else {
                nodesData.forEach(function(node) {
                    nodesData.update({
                        id: node.id,
                        borderWidth: 2,
                        shapeProperties: { borderDashes: false }
                    });
                });
                showToast('Orphan highlight off', 'info');
            }
        }

        // ========================================
        // Detail Panel
        // ========================================
        function showDetail(node) {
            var panel = document.getElementById('detailPanel');
            var data = node._data;
            var cfg = layerConfig[data.layerId];
            document.getElementById('detailBadge').textContent = cfg.name;
            document.getElementById('detailBadge').style.background = cfg.color;
            document.getElementById('detailId').textContent = data.id;
            var props = data.properties || {};
            var html = '<div class="detail-section"><div class="detail-section-title">Properties</div>';
            Object.keys(props).forEach(function(key) {
                if (key === 'processInfo' || key === 'tensileTest') return;
                var val = props[key];
                if (val === '' || val === null || val === undefined) val = '-';
                html += '<div class="detail-row"><span class="detail-key">' + key + '</span><span class="detail-value">' + val + '</span></div>';
            });
            html += '</div>';
            if (props.processInfo) {
                html += '<div class="detail-section"><div class="detail-section-title">Process</div>';
                Object.keys(props.processInfo).forEach(function(key) {
                    html += '<div class="detail-row"><span class="detail-key">' + key + '</span><span class="detail-value">' + (props.processInfo[key] || '-') + '</span></div>';
                });
                html += '</div>';
            }
            document.getElementById('detailBody').innerHTML = html;
            panel.classList.add('active');
        }

        function hideDetail() { document.getElementById('detailPanel').classList.remove('active'); }

        // ========================================
        // Trace Mode - Improved
        // ========================================
        function toggleTraceMode() {
            traceModeActive = !traceModeActive;
            document.getElementById('btnTrace').classList.toggle('active', traceModeActive);
            if (!traceModeActive) clearHighlight();
            showToast('Trace: ' + (traceModeActive ? 'ON' : 'OFF'), 'info');
        }

        function showTrace() {
            if (!selectedNode) return;
            traceModeActive = true;
            document.getElementById('btnTrace').classList.add('active');
            highlightTrace(selectedNode.id);
        }

        function highlightTrace(nodeId) {
            fetch('/api/trace/' + nodeId)
                .then(function(res) { return res.json(); })
                .then(function(trace) {
                    var traceIds = {};
                    traceIds[nodeId] = true;
                    (trace.upstream || []).forEach(function(n) { traceIds[n.id] = true; });
                    (trace.downstream || []).forEach(function(n) { traceIds[n.id] = true; });
                    
                    var traceCount = Object.keys(traceIds).length;
                    
                    nodesData.forEach(function(node) {
                        var inTrace = traceIds[node.id];
                        nodesData.update({
                            id: node.id,
                            opacity: inTrace ? 1 : 0.15,
                            borderWidth: inTrace ? 4 : 1,
                            font: { color: inTrace ? '#1a1a25' : '#64748b', size: 12, face: 'Inter', bold: true }
                        });
                    });
                    edgesData.forEach(function(edge) {
                        var inTrace = traceIds[edge.from] && traceIds[edge.to];
                        edgesData.update({
                            id: edge.id,
                            color: { color: inTrace ? '#6366f1' : '#1a1a25' },
                            width: inTrace ? 3 : 1
                        });
                    });
                    updateMinimap();
                    showToast('Trace: ' + traceCount + ' related nodes', 'info');
                });
        }

        // ========================================
        // Isolate Mode - Hide non-related nodes
        // ========================================
        var isolateModeActive = false;

        function isolateSelected() {
            if (!selectedNode) {
                showToast('Select a node first', 'warning');
                return;
            }
            
            var nodeId = selectedNode.id;
            
            fetch('/api/trace/' + nodeId)
                .then(function(res) { return res.json(); })
                .then(function(trace) {
                    var traceIds = {};
                    traceIds[nodeId] = true;
                    (trace.upstream || []).forEach(function(n) { traceIds[n.id] = true; });
                    (trace.downstream || []).forEach(function(n) { traceIds[n.id] = true; });
                    
                    var visibleCount = Object.keys(traceIds).length;
                    var hiddenCount = 0;
                    
                    // Hide non-related nodes
                    nodesData.forEach(function(node) {
                        var inTrace = traceIds[node.id];
                        if (!inTrace) hiddenCount++;
                        nodesData.update({
                            id: node.id,
                            hidden: !inTrace
                        });
                    });
                    
                    // Update edges visibility
                    edgesData.forEach(function(edge) {
                        var visible = traceIds[edge.from] && traceIds[edge.to];
                        edgesData.update({
                            id: edge.id,
                            hidden: !visible
                        });
                    });
                    
                    isolateModeActive = true;
                    document.getElementById('btnIsolate').classList.add('active');
                    
                    // Fit to visible nodes
                    var visibleNodes = [];
                    nodesData.forEach(function(node) {
                        if (!node.hidden) visibleNodes.push(node.id);
                    });
                    if (visibleNodes.length > 0) {
                        network.fit({ nodes: visibleNodes, animation: { duration: 500 } });
                    }
                    
                    updateMinimap();
                    showToast('Isolated: ' + visibleCount + ' nodes shown, ' + hiddenCount + ' hidden', 'success');
                });
        }

        function clearIsolate() {
            isolateModeActive = false;
            document.getElementById('btnIsolate').classList.remove('active');
            
            // Show all nodes
            nodesData.forEach(function(node) {
                nodesData.update({ id: node.id, hidden: false });
            });
            edgesData.forEach(function(edge) {
                edgesData.update({ id: edge.id, hidden: false });
            });
            
            updateMinimap();
        }

        function clearHighlight() {
            if (!nodesData) return;
            nodesData.forEach(function(node) {
                var cfg = layerConfig[node.layerId] || {};
                nodesData.update({
                    id: node.id,
                    opacity: 1,
                    borderWidth: 2,
                    font: { color: '#1a1a25', size: 12, face: 'Inter', bold: true }
                });
            });
            edgesData.forEach(function(edge) {
                edgesData.update({ id: edge.id, color: { color: '#4a4a5a' }, width: 2 });
            });
            updateMinimap();
        }

        // ========================================
        // Compare Mode
        // ========================================
        function toggleCompareMode() {
            compareModeActive = !compareModeActive;
            document.getElementById('btnCompare').classList.toggle('active', compareModeActive);
            if (compareModeActive) {
                compareList = [];
                hideDetail();
                showToast('Compare mode: Click nodes to select', 'info');
            } else {
                closeCompare();
            }
            updateSelectionInfo();
        }

        function toggleCompareItem(nodeId, node) {
            var idx = compareList.findIndex(function(c) { return c.id === nodeId; });
            if (idx >= 0) {
                compareList.splice(idx, 1);
            } else if (compareList.length < 2) {
                compareList.push({ id: nodeId, data: node._data });
            } else {
                showToast('Max 2 items for compare', 'warning');
                return;
            }
            updateComparePanel();
            updateSelectionInfo();
        }

        function updateComparePanel() {
            document.getElementById('compareCount').textContent = compareList.length;
            if (compareList.length === 2) {
                document.getElementById('comparePanel').classList.add('active');
                renderCompare();
            } else {
                document.getElementById('comparePanel').classList.remove('active');
            }
        }

        function renderCompare() {
            var body = document.getElementById('compareBody');
            var a = compareList[0].data;
            var b = compareList[1].data;
            var propsA = a.properties || {};
            var propsB = b.properties || {};
            var allKeys = Object.keys(propsA).concat(Object.keys(propsB)).filter(function(k, i, arr) { return arr.indexOf(k) === i && k !== 'processInfo' && k !== 'tensileTest'; });
            var html = '<div class="compare-grid">';
            html += '<div class="compare-row"><div class="compare-label">ID</div><div class="compare-value">' + a.id + '</div><div class="compare-value">' + b.id + '</div></div>';
            allKeys.forEach(function(key) {
                var valA = propsA[key] !== undefined ? propsA[key] : '-';
                var valB = propsB[key] !== undefined ? propsB[key] : '-';
                var diff = valA !== valB ? ' diff' : '';
                html += '<div class="compare-row"><div class="compare-label">' + key + '</div><div class="compare-value' + diff + '">' + valA + '</div><div class="compare-value' + diff + '">' + valB + '</div></div>';
            });
            html += '</div>';
            body.innerHTML = html;
        }

        function closeCompare() {
            compareModeActive = false;
            compareList = [];
            document.getElementById('btnCompare').classList.remove('active');
            document.getElementById('comparePanel').classList.remove('active');
            updateSelectionInfo();
        }

        // ========================================
        // Table Drawer
        // ========================================
        function toggleTableDrawer() {
            tableDrawerOpen = !tableDrawerOpen;
            document.getElementById('tableDrawer').classList.toggle('active', tableDrawerOpen);
            if (tableDrawerOpen) {
                renderDrawerTabs();
                renderTable(currentTableLayer);
            }
        }

        function renderDrawerTabs() {
            var container = document.getElementById('drawerTabs');
            var html = '';
            Object.keys(layerConfig).forEach(function(key) {
                var cfg = layerConfig[key];
                var active = currentTableLayer === key ? ' active' : '';
                html += '<button class="drawer-tab' + active + '" onclick="switchTable(\'' + key + '\')">' + cfg.name + '</button>';
            });
            container.innerHTML = html;
        }

        function switchTable(layer) {
            currentTableLayer = layer;
            renderDrawerTabs();
            renderTable(layer);
        }

        function renderTable(layer) {
            var body = document.getElementById('drawerBody');
            var data = rawData[layer] || [];
            if (data.length === 0) {
                body.innerHTML = '<p style="color:var(--text-muted);font-size:0.8em;">No data</p>';
                return;
            }
            var keys = Object.keys(data[0]).filter(function(k) { return k !== 'processInfo' && k !== 'tensileTest'; });
            var html = '<table class="data-table"><thead><tr>';
            keys.forEach(function(k) { html += '<th>' + k + '</th>'; });
            html += '</tr></thead><tbody>';
            data.forEach(function(row) {
                html += '<tr onclick="selectNodeById(\'' + row.id + '\')">';
                keys.forEach(function(k) { html += '<td>' + (row[k] !== undefined ? row[k] : '-') + '</td>'; });
                html += '</tr>';
            });
            html += '</tbody></table>';
            body.innerHTML = html;
        }

        function selectNodeById(id) {
            var node = nodesData.get(id);
            if (node) {
                network.selectNodes([id]);
                network.focus(id, { scale: 1.5, animation: { duration: 300 } });
                selectedNode = node;
                showDetail(node);
                updateMinimap();
            }
        }

        // ========================================
        // Add/Edit/Paste Modals (same as before)
        // ========================================
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            updateAddForm();
        }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

        function updateAddForm() {
            var layer = document.getElementById('addLayerType').value;
            var cfg = layerConfig[layer];
            var fields = cfg.fields || [];
            var html = '';
            fields.forEach(function(field) {
                html += '<div class="form-group"><label class="form-label">' + field + '</label>';
                if (field === 'id') {
                    html += '<input type="text" class="form-input" id="add_' + field + '" placeholder="Auto-generated if empty">';
                } else if (field === 'note') {
                    html += '<textarea class="form-textarea" id="add_' + field + '" rows="2"></textarea>';
                } else if (field === 'materialId') {
                    html += '<select class="form-select" id="add_' + field + '">' + getOptionsFor('material') + '</select>';
                } else if (field === 'heatTreatId') {
                    html += '<select class="form-select" id="add_' + field + '">' + getOptionsFor('heatTreatment') + '</select>';
                } else if (field === 'productId') {
                    html += '<select class="form-select" id="add_' + field + '">' + getOptionsFor('product') + '</select>';
                } else {
                    html += '<input type="text" class="form-input" id="add_' + field + '">';
                }
                html += '</div>';
            });
            document.getElementById('addFormFields').innerHTML = html;
        }

        function getOptionsFor(layer) {
            var data = rawData[layer] || [];
            var html = '<option value="">-- Select --</option>';
            data.forEach(function(item) { html += '<option value="' + item.id + '">' + item.id + '</option>'; });
            return html;
        }

        function submitAddNode() {
            var layer = document.getElementById('addLayerType').value;
            var cfg = layerConfig[layer];
            var fields = cfg.fields || [];
            var newData = {};
            fields.forEach(function(field) {
                var el = document.getElementById('add_' + field);
                if (el) newData[field] = el.value;
            });
            if (!newData.id) newData.id = layer.charAt(0).toUpperCase() + Date.now().toString().slice(-6);
            if (!rawData[layer]) rawData[layer] = [];
            rawData[layer].push(newData);
            var nodeLabel = newData.id;
            if (newData.steelGrade) nodeLabel = newData.steelGrade + '\n' + (newData.maker || '');
            if (newData.quenchMethod) nodeLabel = newData.quenchMethod + ' ' + newData.quenchTemp + 'C';
            var newNode = { id: newData.id, layerId: layer, level: Object.keys(layerConfig).indexOf(layer), label: nodeLabel, color: cfg.color, properties: newData };
            allNodes.push(newNode);
            nodesData.add({
                id: newData.id, label: nodeLabel, level: newNode.level, layerId: layer,
                color: { background: cfg.color, border: cfg.color, highlight: { background: '#ffffff', border: cfg.color } },
                font: { color: '#1a1a25', size: 12, bold: true }, shape: 'box', borderWidth: 2, margin: { top: 10, bottom: 10, left: 12, right: 12 }, shadow: true, _data: newNode
            });
            if (newData.materialId) edgesData.add({ from: newData.materialId, to: newData.id, color: { color: '#4a4a5a' }, width: 2, arrows: { to: { enabled: true, scaleFactor: 0.5 } } });
            if (newData.heatTreatId) edgesData.add({ from: newData.heatTreatId, to: newData.id, color: { color: '#4a4a5a' }, width: 2, arrows: { to: { enabled: true, scaleFactor: 0.5 } } });
            if (newData.productId) edgesData.add({ from: newData.productId, to: newData.id, color: { color: '#4a4a5a' }, width: 2, arrows: { to: { enabled: true, scaleFactor: 0.5 } } });
            renderStats();
            closeAddModal();
            updateMinimap();
            showToast('Node added: ' + newData.id, 'success');
        }

        function editNode() {
            if (!selectedNode) return;
            var data = selectedNode._data;
            var layer = data.layerId;
            var props = data.properties || {};
            document.getElementById('editNodeId').textContent = data.id;
            var cfg = layerConfig[layer];
            var fields = cfg ? cfg.fields : Object.keys(props);
            var html = '';
            fields.forEach(function(field) {
                var val = props[field] !== undefined ? props[field] : '';
                html += '<div class="form-group"><label class="form-label">' + field + '</label>';
                if (field === 'id') {
                    html += '<input type="text" class="form-input" id="edit_' + field + '" value="' + val + '" readonly style="opacity:0.6;">';
                } else if (field === 'note') {
                    html += '<textarea class="form-textarea" id="edit_' + field + '" rows="2">' + val + '</textarea>';
                } else {
                    html += '<input type="text" class="form-input" id="edit_' + field + '" value="' + val + '">';
                }
                html += '</div>';
            });
            document.getElementById('editFormFields').innerHTML = html;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

        function submitEditNode() {
            if (!selectedNode) return;
            var data = selectedNode._data;
            var layer = data.layerId;
            var props = data.properties || {};
            var cfg = layerConfig[layer];
            var fields = cfg ? cfg.fields : Object.keys(props);
            fields.forEach(function(field) {
                var el = document.getElementById('edit_' + field);
                if (el && field !== 'id') props[field] = el.value;
            });
            var arr = rawData[layer] || [];
            var idx = arr.findIndex(function(r) { return r.id === data.id; });
            if (idx >= 0) arr[idx] = props;
            var nodeLabel = data.id;
            if (props.steelGrade) nodeLabel = props.steelGrade + '\n' + (props.maker || '');
            if (props.quenchMethod) nodeLabel = props.quenchMethod + ' ' + props.quenchTemp + 'C';
            nodesData.update({ id: data.id, label: nodeLabel });
            closeEditModal();
            showDetail(selectedNode);
            showToast('Node updated: ' + data.id, 'success');
        }

        function openPasteModal() {
            document.getElementById('pasteModal').classList.add('active');
            document.getElementById('pasteInput').value = '';
            document.getElementById('mappingSection').style.display = 'none';
            document.getElementById('pasteSubmitBtn').disabled = true;
            pastedData = null;
        }

        function closePasteModal() { document.getElementById('pasteModal').classList.remove('active'); }

        function setupPasteArea() {
            var area = document.getElementById('pasteArea');
            area.addEventListener('dragover', function(e) { e.preventDefault(); area.classList.add('dragover'); });
            area.addEventListener('dragleave', function() { area.classList.remove('dragover'); });
            area.addEventListener('drop', function(e) {
                e.preventDefault();
                area.classList.remove('dragover');
                var file = e.dataTransfer.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(ev) { processPastedText(ev.target.result); };
                    reader.readAsText(file);
                }
            });
        }

        function handlePaste(e) { processPastedText(e.clipboardData.getData('text')); }

        function processPastedText(text) {
            if (!text || !text.trim()) return;
            var lines = text.trim().split('\n');
            if (lines.length < 2) { showToast('Need header + data rows', 'warning'); return; }
            var delimiter = text.indexOf('\t') >= 0 ? '\t' : ',';
            var headers = lines[0].split(delimiter).map(function(h) { return h.trim(); });
            var rows = [];
            for (var i = 1; i < lines.length; i++) {
                var cols = lines[i].split(delimiter).map(function(c) { return c.trim(); });
                if (cols.length === headers.length) {
                    var row = {};
                    headers.forEach(function(h, idx) { row[h] = cols[idx]; });
                    rows.push(row);
                }
            }
            if (rows.length === 0) { showToast('No valid data rows', 'warning'); return; }
            pastedData = { headers: headers, rows: rows };
            showMappingUI();
        }

        function showMappingUI() {
            var layer = document.getElementById('pasteLayerType').value;
            var cfg = layerConfig[layer];
            var dbFields = cfg.fields || [];
            var excelHeaders = pastedData.headers;
            var container = document.getElementById('mappingContainer');
            var html = '';
            dbFields.forEach(function(dbField) {
                var guessedMatch = '';
                excelHeaders.forEach(function(h) { if (h.toLowerCase() === dbField.toLowerCase()) guessedMatch = h; });
                html += '<div class="mapping-row"><select class="form-select mapping-select" data-dbfield="' + dbField + '"><option value="">-- Skip --</option>';
                excelHeaders.forEach(function(h) { html += '<option value="' + h + '"' + (h === guessedMatch ? ' selected' : '') + '>' + h + '</option>'; });
                html += '</select><span class="mapping-arrow">-></span><span style="font-size:0.75em;font-weight:500;">' + dbField + '</span></div>';
            });
            container.innerHTML = html;
            var preview = document.getElementById('previewTable');
            var previewHtml = '<table><thead><tr>';
            excelHeaders.forEach(function(h) { previewHtml += '<th>' + h + '</th>'; });
            previewHtml += '</tr></thead><tbody>';
            pastedData.rows.slice(0, 3).forEach(function(row) {
                previewHtml += '<tr>';
                excelHeaders.forEach(function(h) { previewHtml += '<td>' + (row[h] || '') + '</td>'; });
                previewHtml += '</tr>';
            });
            if (pastedData.rows.length > 3) previewHtml += '<tr><td colspan="' + excelHeaders.length + '" style="text-align:center;color:var(--text-muted);">... ' + (pastedData.rows.length - 3) + ' more</td></tr>';
            previewHtml += '</tbody></table>';
            preview.innerHTML = previewHtml;
            document.getElementById('mappingSection').style.display = 'block';
            document.getElementById('pasteSubmitBtn').disabled = false;
        }

        function submitPasteData() {
            if (!pastedData) return;
            var layer = document.getElementById('pasteLayerType').value;
            var cfg = layerConfig[layer];
            var selects = document.querySelectorAll('.mapping-select');
            var mapping = {};
            selects.forEach(function(sel) { var dbField = sel.getAttribute('data-dbfield'); var excelCol = sel.value; if (excelCol) mapping[dbField] = excelCol; });
            var addedCount = 0;
            pastedData.rows.forEach(function(row) {
                var newData = {};
                Object.keys(mapping).forEach(function(dbField) { newData[dbField] = row[mapping[dbField]] || ''; });
                if (!newData.id) newData.id = layer.charAt(0).toUpperCase() + Date.now().toString().slice(-6) + addedCount;
                if (!rawData[layer]) rawData[layer] = [];
                rawData[layer].push(newData);
                var nodeLabel = newData.id;
                if (newData.steelGrade) nodeLabel = newData.steelGrade + '\n' + (newData.maker || '');
                if (newData.quenchMethod) nodeLabel = newData.quenchMethod + ' ' + newData.quenchTemp + 'C';
                var newNode = { id: newData.id, layerId: layer, level: Object.keys(layerConfig).indexOf(layer), label: nodeLabel, color: cfg.color, properties: newData };
                allNodes.push(newNode);
                nodesData.add({
                    id: newData.id, label: nodeLabel, level: newNode.level, layerId: layer,
                    color: { background: cfg.color, border: cfg.color }, font: { color: '#1a1a25', size: 12, bold: true },
                    shape: 'box', borderWidth: 2, margin: { top: 10, bottom: 10, left: 12, right: 12 }, shadow: true, _data: newNode
                });
                addedCount++;
            });
            renderStats();
            closePasteModal();
            updateMinimap();
            showToast(addedCount + ' nodes imported', 'success');
        }

        // ========================================
        // Export
        // ========================================
        function exportData() {
            var data = { nodes: allNodes, edges: allEdges, rawData: rawData };
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'experiment-data.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        }

        // ========================================
        // Utilities
        // ========================================
        function fitGraph() {
            if (network) {
                network.fit({ animation: { duration: 500 } });
                setTimeout(updateMinimap, 600);
            }
        }

        function resetView() {
            currentFilter = 'all';
            traceModeActive = false;
            compareModeActive = false;
            compareList = [];
            orphanHighlightActive = false;
            isolateModeActive = false;
            document.getElementById('btnTrace').classList.remove('active');
            document.getElementById('btnCompare').classList.remove('active');
            document.getElementById('btnIsolate').classList.remove('active');
            document.getElementById('comparePanel').classList.remove('active');
            
            // Show all nodes and reset styles
            nodesData.forEach(function(node) {
                var cfg = layerConfig[node.layerId] || {};
                nodesData.update({
                    id: node.id,
                    hidden: false,
                    opacity: 1,
                    borderWidth: 2,
                    font: { color: '#1a1a25', size: 12, face: 'Inter', bold: true }
                });
            });
            edgesData.forEach(function(edge) {
                edgesData.update({
                    id: edge.id,
                    hidden: false,
                    color: { color: '#4a4a5a' },
                    width: 2
                });
            });
            
            filterLayer('all');
            fitGraph();
            updateSelectionInfo();
        }

        function showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('active', show); }

        function showToast(text, type) {
            var toast = document.getElementById('toast');
            toast.className = 'toast ' + (type || 'info');
            document.getElementById('toastText').textContent = text;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function lightenColor(hex, percent) {
            var num = parseInt(hex.replace('#', ''), 16);
            var amt = Math.round(2.55 * percent);
            var R = Math.min(255, (num >> 16) + amt);
            var G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
            var B = Math.min(255, (num & 0x0000FF) + amt);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
