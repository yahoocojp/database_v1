<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Training - R&D Experiment Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Phase 1A++ Libraries -->
    <script src="/lib/toast.js"></script>
    <script src="/lib/error-handler.js"></script>
    <script src="/lib/debug-manager.js"></script>
    <script src="/lib/websocket-manager.js"></script>

    <!-- Refactored: External CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/ml-training.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-brain"></i> モデル学習</h1>
            <p>データセットから機械学習モデルを学習</p>
        </div>

        <div class="nav">
            <a href="/"><i class="fas fa-project-diagram"></i> Database App</a>
            <a href="/ml-app.html"><i class="fas fa-database"></i> データセット管理</a>
            <a href="/ml-training.html" style="background: #667eea; color: white;"><i class="fas fa-graduation-cap"></i> モデル学習</a>
        </div>

        <div class="content">
            <div class="alert alert-info">
                <strong><i class="fas fa-info-circle"></i> 学習手順：</strong>
                データセット選択 → モデル設定 → 変数選択 → 学習実行
            </div>

            <!-- ウィザード -->
            <div class="wizard">
                <div class="wizard-steps">
                    <div class="wizard-step active" data-step="1">
                        <div class="wizard-step-circle">1</div>
                        <div class="wizard-step-label">データセット</div>
                    </div>
                    <div class="wizard-step" data-step="2">
                        <div class="wizard-step-circle">2</div>
                        <div class="wizard-step-label">モデル設定</div>
                    </div>
                    <div class="wizard-step" data-step="3">
                        <div class="wizard-step-circle">3</div>
                        <div class="wizard-step-label">変数選択</div>
                    </div>
                    <div class="wizard-step" data-step="4">
                        <div class="wizard-step-circle">4</div>
                        <div class="wizard-step-label">確認・実行</div>
                    </div>
                </div>

                <!-- Step 1: データセット選択 -->
                <div class="form-section active" data-step="1">
                    <h3>データセット選択</h3>
                    <div id="autoLoadNotification" style="display:none; margin-bottom: 15px;" class="alert alert-success">
                        <i class="fas fa-check-circle"></i> <span id="autoLoadMessage"></span>
                    </div>
                    <div class="form-group">
                        <label>学習に使用するデータセットを選択してください</label>
                        <select id="datasetSelect">
                            <option value="">データセットを読み込み中...</option>
                        </select>
                    </div>
                    <div id="datasetInfo" style="display:none;" class="alert alert-info">
                        <strong>データセット情報：</strong>
                        <div id="datasetDetails"></div>
                    </div>
                </div>

                <!-- Step 2: モデル設定 -->
                <div class="form-section" data-step="2">
                    <h3>モデル設定</h3>
                    <div class="form-group">
                        <label>学習モデル</label>
                        <select id="modelSelect">
                            <option value="catboost">CatBoost（推奨・高速・高精度）</option>
                            <option value="lightgbm">LightGBM（軽量・高速）</option>
                            <option value="mlp">ニューラルネットワーク（複雑なパターン向け）</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong><i class="fas fa-lightbulb"></i> モデル選択のヒント：</strong><br>
                        • <strong>CatBoost</strong>: 一般的な回帰タスクに最適。欠損値に強い。<br>
                        • <strong>LightGBM</strong>: 大量データでも高速。メモリ効率良好。<br>
                        • <strong>ニューラルネットワーク</strong>: 非線形な関係性を学習。正規化が必要。
                    </div>
                </div>

                <!-- Step 3: 変数選択 -->
                <div class="form-section" data-step="3">
                    <h3>変数選択</h3>
                    <div class="alert alert-info">
                        ドラッグ&ドロップでカラムを配置してください
                    </div>
                    <div class="column-selector">
                        <div class="column-buckets">
                            <div class="column-bucket" id="featuresBucket" data-type="features">
                                <h4><i class="fas fa-th-list"></i> 説明変数（X）</h4>
                                <div class="bucket-items"></div>
                            </div>
                            <div class="column-bucket" id="targetBucket" data-type="target">
                                <h4><i class="fas fa-bullseye"></i> 目的変数（Y）</h4>
                                <div class="bucket-items"></div>
                            </div>
                            <div class="column-bucket" id="cvGroupBucket" data-type="cv_group">
                                <h4><i class="fas fa-layer-group"></i> CV用グループ（任意）</h4>
                                <div class="bucket-items"></div>
                            </div>
                            <div class="column-bucket" id="unusedBucket" data-type="unused">
                                <h4><i class="fas fa-ban"></i> 使用しない</h4>
                                <div class="bucket-items"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: 確認・実行 -->
                <div class="form-section" data-step="4">
                    <h3>設定確認</h3>
                    <div id="confirmationDetails"></div>
                </div>

                <!-- ボタンエリア -->
                <div class="button-group">
                    <button class="btn btn-secondary" id="prevBtn" onclick="previousStep()" style="display:none;">
                        <i class="fas fa-arrow-left"></i> 戻る
                    </button>
                    <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                        次へ <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="btn btn-primary" id="trainBtn" onclick="startTraining()" style="display:none;">
                        <i class="fas fa-play"></i> 学習開始
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- プログレスダイアログ -->
    <div class="modal" id="trainingModal">
        <div class="modal-content">
            <h3 id="modalTitle"><i class="fas fa-spinner fa-spin"></i> 学習中...</h3>

            <div class="progress-container">
                <div class="progress-bar" id="trainingProgress" style="width: 0%;">
                    <span id="progressText">0%</span>
                </div>
            </div>

            <div class="log-container" id="trainingLog"></div>

            <div id="resultSummary" class="result-summary" style="display:none;">
                <h4><i class="fas fa-check-circle"></i> 学習完了</h4>
                <div id="metricsContainer"></div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTrainingDialog()">
                    <i class="fas fa-times"></i> 閉じる
                </button>
                <button class="btn btn-primary" id="viewResultBtn" style="display:none;" onclick="viewResults()">
                    <i class="fas fa-chart-line"></i> 結果を表示
                </button>
            </div>
        </div>
    </div>

    <!-- Refactored: External JavaScript -->
    <script src="/js/ml-training.js"></script>
</body>
</html>
